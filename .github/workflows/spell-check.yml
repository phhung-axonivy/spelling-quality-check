name: Spell Check

permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      workingRepos:
        description: 'Comma-separated list of repository names. e.g., a-trust-connector,process-analyser. If this field is left empty, spell checking will be applied to all market extensions.'
      workingBranch:
        description: 'Which branch needs to be spell-checked? e.g., master, release/12.0, ...'
        default: 'master'
        required: true

env:
  WORKING_ORG: axonivy-market

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repo-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix dynamically
        id: set-matrix
        env:
          GH_TOKEN: ${{ github.token }}
          WORKING_ORG: ${{ env.WORKING_ORG }}
        run: |
          ORG="${WORKING_ORG}"
          INPUT_REPOS="${{ github.event.inputs.workingRepos }}"
          if [ -n "$INPUT_REPOS" ]; then
            REPOS=$(jq -R 'split(",")' <<< "$INPUT_REPOS")
          else
          # Get full repo list from org
            REPOS=$(gh repo list "$ORG" --limit 1000 --json name -q '[.[].name]')
            echo "ðŸ“¦ Found repos: $REPOS"
          fi
          # Build matrix JSON object
          MATRIX_JSON=$(jq -n --argjson repos "$REPOS" '{ include: $repos }')
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  spell-check:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.prepare.outputs.repo-matrix).include }}

    steps:
      - name: Install CSpell
        run: npm install -g cspell@latest

      - name: Check CSpell version
        run: cspell --version

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.WORKING_ORG }}/${{ matrix.repo }}
          path: target-repo
          ref: ${{ github.event.inputs.workingBranch }}

      - name: Debug list root files
        run: |
          echo "Current working dir: $(pwd)"
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -al $GITHUB_WORKSPACE

      - name: Copy cspell.json config
        run: cp $GITHUB_WORKSPACE/cspell.json target-repo/

      - name: Run CSpell - Spell Check
        run: |
          REPO="${{ matrix.repo }}"
          echo "ðŸ”¤ðŸ” ${{ env.WORKING_ORG }}/$REPO - branch:${{ github.event.inputs.workingBranch }} ..."
          cd target-repo
          cspell lint --config ../cspell.json > $REPO.txt

      - name: Upload Spell Check Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.repo }}
          path: target-repo/*.txt
